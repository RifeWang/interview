
# MySQL

## 事务及锁机制、索引等原理

事务：多个操作要么全部成功，要么全部失败

事务的特点 ACID :
- A : `atomicity`   原子性
- C : `consistency` 一致性
- I : `isolation`   隔离性
- D : `durability`  持久性

并发控制、日志恢复


- 事务的原子性是通过 `undo log` 来实现
- 事务的持久性是通过 `redo log` 来实现
- 事务的隔离性是通过 `读写锁 + MVCC` 来实现
- 事务的一致性是通过 `原子性、持久性、隔离性` 来实现


`undo log` 是逻辑日志，可以理解为记录当前操作的相反操作。

`redo log` 记录的是新数据的备份。在事务提交前，只要将 redo log 持久化即可，不需要将数据持久化。当系统崩溃时，虽然数据没有持久化，但是可以根据 redo log 的内容将数据恢复到最新的状态。


数据写入 > buffer > fsync 刷盘


事务的隔离级别：
- `READ UNCOMMITTED` 读未提交，对事务处理的读取没有任何限制，不推荐。 问题：`脏读、不可重复读、幻读`
- `READ COMMITTED`   读已提交。 问题：`不可重复读、幻读`
- `REPEATABLE READ`  可重复读。 问题：`幻读`
- `SERIALIZABLE`     串行化


`脏读`: 读取到未提交的数据
`不可重复读`: 同一个事务中两次读取的数据不一致
`幻读`: 在同一个事务里，select 的结果是事务开始时时间点的状态，因此，同样的 select 操作读到的结果会是一致的，但是，会有幻读现象。MySQL 的 InnoDB 引擎可以通过 next-key locks 机制（参考"行锁的算法"）来避免幻读。幻读应该是事务对另外事务的插入操作没有隔离，导致了同一个事务里面同样的查询条件出现不同条数的查询结果。


锁：
- `共享锁` ：其他事务只能查询
- `排他锁` ：


## 三星索引

- 如果与一个查询相关的索引行是相邻的，或者至少相距足够靠近的话，就可以标上第一颗星，这是最小化了必须扫描的索引片的宽度
- 如果索引行的顺序与查询语句的需求一致，可以标记为第二颗星，这排除了排序操作
- 如果索引行包含查询语句中的所有列，可以标记为第三颗星，避免了访问表的操作，仅访问索引就可以了

优点：
- 减少查询需要扫描的数据量(加快了查询速度)
- 减少服务器的排序操作和创建临时表的操作(加快了groupby和orderby等操作)
- 将服务器的随机IO变为顺序IO(加快查询速度)

简单的记为：
- where 条件命中索引
- order by 命中索引
- select 列命中索引

## InnoDB: B+ tree 、聚簇索引

B+ tree: 只有叶子结点存储数据 value ，其他结点只存储索引 key
聚簇索引: 索引和数据同为一个文件
非聚簇索引: 非主键索引

InnoDB 会以主键+数据构建聚簇索引，辅助索引构建非主键索引（索引+主键），通过辅助索引查数据一般是先找到主键，再通过主键回表


强制使用索引、禁止使用索引：
- `force index`: `select * from table force index`
- `ignore index`: `select * from table ignore index`
